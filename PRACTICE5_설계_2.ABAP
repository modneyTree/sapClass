*&---------------------------------------------------------------------*
*& Report ZEDR20_PRACTICE005
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT ZEDR20_PRACTICE005.

TABLES : ZEDT20_004.
TABLES : ZEDT20_005, ZEDT20_006.
TABLES : ZEDT20_007.
TABLES : ZEDT20_008.

DATA : BEGIN OF GS_PERNR, "사원정보테이블
  ZPERNR LIKE ZEDT20_004-ZPERNR, "사원번호
  ZPNAME LIKE ZEDT20_005-ZPNAME, "사원이름
  ZDEPCODE LIKE ZEDT20_004-ZDEPCODE, "부서코드
  ZDEPRANK LIKE ZEDT20_004-ZDEPRANK, "직급
  ZEDATE LIKE ZEDT20_004-ZEDATE, "입사일
  ZQFLAG LIKE ZEDT20_004-ZQFLAG, "퇴직상태
  ZGENDER LIKE ZEDT20_005-ZGENDER, "성별
  ZADDRESS LIKE ZEDT20_005-ZADDRESS, "주소
  ZBANKCODE LIKE ZEDT20_008-ZBANKCODE, "은행코드
  ZACCOUNT LIKE ZEDT20_008-ZACCOUNT, "계좌번호
  END OF GS_PERNR.
DATA : GT_PERNR LIKE TABLE OF GS_PERNR.

DATA : BEGIN OF GS_PERNR_ALV, "사원정보 ALV출력용
  ZPERNR LIKE ZEDT20_004-ZPERNR, "사원번호
  ZPNAME LIKE ZEDT20_005-ZPNAME, "사원이름
  ZDEPCODE LIKE ZEDT20_004-ZDEPCODE, "부서코드
  ZDEPCODE_NAME(10), "부서명
  ZDEPRANK_NAME(6),  "직급명
  ZEDATE LIKE ZEDT20_004-ZEDATE, "입사일
  ZQFLAG_NAME(4), "퇴직상태
  ZGENDER_NAME(4), "성별
  ZADDRESS LIKE ZEDT20_005-ZADDRESS, "주소
  ZBANKCODE LIKE ZEDT20_008-ZBANKCODE, "은행코드
  ZBANK_NAME(10),"은행명
  ZACCOUNT LIKE ZEDT20_008-ZACCOUNT, "계좌번호
  END OF GS_PERNR_ALV.
DATA : GT_PERNR_ALV LIKE TABLE OF GS_PERNR_ALV.

DATA : BEGIN OF GS_SALARY, "월급지급테이블
  ZPERNR LIKE ZEDT20_004-ZPERNR, "사원번호
  ZSALARY LIKE ZEDT20_008-ZSALARY, "계약금액
  ZPAY LIKE ZEDT20_008-ZSALARY, "월급
  ZRANK LIKE ZEDT20_006-ZRANK, "평가등급
  END OF GS_SALARY.
DATA : GT_SALARY LIKE TABLE OF GS_SALARY.

DATA : BEGIN OF GS_ASSESS, "평가테이블
  ZPERNR LIKE ZEDT20_004-ZPERNR, "사원번호
  ZPNAME LIKE ZEDT20_005-ZPNAME, "사원이름
  ZDEPCODE LIKE ZEDT20_004-ZDEPCODE, "부서코드
  ZDEPRANK LIKE ZEDT20_004-ZDEPRANK, "직급
  ZEDATE LIKE ZEDT20_004-ZEDATE, "입사일
  ZSALARY LIKE ZEDT20_008-ZSALARY, "계약금액
  ZRANK LIKE ZEDT20_006-ZRANK, "평가등급
  END OF GS_ASSESS.
DATA : GT_ASSESS LIKE TABLE OF GS_ASSESS.

DATA : BEGIN OF GS_ASSESS_ALV, "평가테이블 ALV출력용
  ZPERNR LIKE ZEDT20_004-ZPERNR, "사원번호
  ZPNAME LIKE ZEDT20_005-ZPNAME, "사원이름
  ZDEPCODE LIKE ZEDT20_004-ZDEPCODE, "부서코드
  ZDEPCODE_NAME(10), "부서명
  ZDEPRANK_NAME(6),  "직급명
  ZEDATE LIKE ZEDT20_004-ZEDATE, "입사일
  ZSALARY LIKE ZEDT20_008-ZSALARY, "계약금액
  ZRANK LIKE ZEDT20_006-ZRANK, "평가등급
  ZMON LIKE ZEDT20_007-ZMON01, "월급
  END OF GS_ASSESS_ALV.
DATA : GT_ASSESS_ALV LIKE TABLE OF GS_ASSESS_ALV.


"삭제용
DATA : GT_STUDENT LIKE TABLE OF ZEDT20_002.

DATA : GS_FIELDCAT TYPE SLIS_FIELDCAT_ALV.
DATA : GT_FIELDCAT TYPE SLIS_T_FIELDCAT_ALV.

DATA : GS_LAYOUT TYPE SLIS_LAYOUT_ALV.

DATA : GS_SORT TYPE SLIS_SORTINFO_ALV.
DATA : GT_SORT TYPE SLIS_T_SORTINFO_ALV.

SELECTION-SCREEN BEGIN OF BLOCK B2 WITH FRAME.
  SELECT-OPTIONS : S_ZPERNR FOR ZEDT20_004-ZPERNR.
  SELECT-OPTIONS : S_DATE FOR ZEDT20_004-DATBI MODIF ID M1. "날짜
  PARAMETERS : S_ZDEP LIKE ZEDT20_004-ZDEPCODE MODIF ID M1. "부서코드

  "체크 : 월급지급
  PARAMETERS : P_YEAR LIKE ZEDT00_007-ZYEAR DEFAULT SY-DATUM+0(4) MODIF ID M2.
  PARAMETERS : P_MON(2) DEFAULT SY-DATUM+4(2) MODIF ID M2 .
SELECTION-SCREEN END OF BLOCK B2.

SELECTION-SCREEN BEGIN OF BLOCK B3 WITH FRAME.
  PARAMETERS : P_INFO RADIOBUTTON GROUP R1 DEFAULT 'X' USER-COMMAND UC1.
  PARAMETERS : P_MONEY RADIOBUTTON GROUP R1.
  PARAMETERS : P_TEST RADIOBUTTON GROUP R1.
SELECTION-SCREEN END OF BLOCK B3.

SELECTION-SCREEN BEGIN OF BLOCK B4 WITH FRAME.
  PARAMETERS : Z_CHECK AS CHECKBOX DEFAULT 'X'.
SELECTION-SCREEN END OF BLOCK B4.


INITIALIZATION.
PERFORM SET_DATE.
APPEND S_DATE.

AT SELECTION-SCREEN OUTPUT.
  LOOP AT SCREEN.
    IF SCREEN-GROUP1 = 'SC1'.
      SCREEN-INPUT = 0.
    ENDIF.

    IF SCREEN-GROUP1 = 'M1'.
      IF P_INFO = 'X'.
        SCREEN-ACTIVE = '1'.
      ELSEIF P_MONEY = 'X'.
        SCREEN-ACTIVE = '0'.
      ELSEIF P_TEST = 'X'.
        SCREEN-ACTIVE = '0'.
      ENDIF.
    ENDIF.

    IF SCREEN-GROUP1 = 'M2'.
      IF P_INFO = 'X'.
        SCREEN-ACTIVE = '0'.
      ELSEIF P_MONEY = 'X'.
        SCREEN-ACTIVE = '1'.
      ELSEIF P_TEST = 'X'.
        SCREEN-ACTIVE = '1'.
      ENDIF.
    ENDIF.

    MODIFY SCREEN.
  ENDLOOP.


START-OF-SELECTION.
  "점검


END-OF-SELECTION.
   PERFORM ALV_DISPLAY.


FORM SET_DATE .

  IF S_DATE[] IS INITIAL.
    CONCATENATE SY-DATUM(4) '01' '01' INTO S_DATE-LOW.
    S_DATE-HIGH = SY-DATUM(6) && '01'. "&&로도 표현 가능 (=CONCATENATE)
    S_DATE-SIGN = 'I'.
    S_DATE-OPTION = 'BT'.

    CALL FUNCTION 'LAST_DAY_OF_MONTHS'
      EXPORTING
        DAY_IN            = S_DATE-HIGH
      IMPORTING
        LAST_DAY_OF_MONTH = S_DATE-HIGH.

    APPEND S_DATE.
  ENDIF.

ENDFORM.



FORM ALV_DISPLAY .

  PERFORM FIELD_CATALOG.
*  PERFORM ALV_LAYOUT.
*  PERFORM ALV_SORT.
  PERFORM CALL_ALV.

ENDFORM.

FORM GET_DATA.
"   SELECT * FROM ZEDT20_002
"     INTO CORRESPONDING FIELDS OF TABLE GT_STUDENT
"     WHERE ZCODE IN S_ZCODE.

  SELECT A~ZPERNR "사원번호
         B~ZPNAME "사원이름
         A~ZDEPCODE "부서코드
         A~ZDEPRANK "직급코드
         A~ZEDATE "입사일
         A~ZQFLAG "퇴직상태
         B~ZGENDER "성별
         B~ZADDRESS "주소
         C~ZBANKCODE "은행코드
         C~ZACCOUNT "계좌번호
    INTO CORRESPONDING FIELDS OF TABLE GT_PERNR
    FROM ZEDT20_004 AS A
    INNER JOIN ZEDT20_005 AS B
    ON A~ZPERNR = B~ZPERNR
    INNER JOIN ZEDT20_008 AS C
    ON A~ZPERNR = C~ZPERNR
    WHERE A~ZPERNR IN S_ZPERNR.

*    SELECT *
*    INTO CORRESPONDING FIELDS OF TABLE GT_PERNR
*    FROM ZEDT20_004 INNER JOIN ZEDT20_008 ON ZEDT20_004~ZPERNR = ZEDT20_008~ZPERNR
*    WHERE ZEDT20_004~ZPERNR IN S_ZPERNR.

*    SELECT * FROM ZEDT20_004
*    INTO CORRESPONDING FIELDS OF TABLE GT_PERNR
*    WHERE ZPERNR IN S_ZPERNR.



ENDFORM.

*FORM WRITE_DATA. " 함수명 수정
*  LOOP AT GT_STUDENT INTO GS_STUDENT.
*    WRITE :/ GS_STUDENT-ZCODE, GS_STUDENT-ZKNAME.
*  ENDLOOP.
*ENDFORM.

FORM FIELD_CATALOG .

  DATA : L_TEXT(10).

  CLEAR : GS_FIELDCAT, GT_FIELDCAT.
  GS_FIELDCAT-COL_POS = 1.
  GS_FIELDCAT-FIELDNAME = 'ZPERNR'.
  GS_FIELDCAT-SELTEXT_M = '사원번호'.
  GS_FIELDCAT-KEY = 'X'.
  APPEND GS_FIELDCAT TO GT_FIELDCAT.

  CLEAR : GS_FIELDCAT.
  GS_FIELDCAT-COL_POS = 2.
  GS_FIELDCAT-FIELDNAME = 'ZPNAME'.
  GS_FIELDCAT-SELTEXT_M = '사원이름'.
  GS_FIELDCAT-KEY = 'X'.
  APPEND GS_FIELDCAT TO GT_FIELDCAT.

  CLEAR : GS_FIELDCAT.
  GS_FIELDCAT-COL_POS = 3.
  GS_FIELDCAT-FIELDNAME = 'ZDEPCODE'.
  GS_FIELDCAT-SELTEXT_M = '부서코드'.
  APPEND GS_FIELDCAT TO GT_FIELDCAT.

  CLEAR : GS_FIELDCAT.
  GS_FIELDCAT-COL_POS = 4.
  GS_FIELDCAT-FIELDNAME = 'ZDEPCODE_NAME'.
  GS_FIELDCAT-SELTEXT_M = '부서명'.
  APPEND GS_FIELDCAT TO GT_FIELDCAT.

  CLEAR : GS_FIELDCAT.
  GS_FIELDCAT-COL_POS = 5.
  GS_FIELDCAT-FIELDNAME = 'ZDEPRANK_NAME'.
  GS_FIELDCAT-SELTEXT_M = '직급명'.
  APPEND GS_FIELDCAT TO GT_FIELDCAT.

  CLEAR : GS_FIELDCAT.
  GS_FIELDCAT-COL_POS = 6.
  GS_FIELDCAT-FIELDNAME = 'ZEDATE'.
  GS_FIELDCAT-SELTEXT_M = '입사일'.
  GS_FIELDCAT-OUTPUTLEN = '10'.
  APPEND GS_FIELDCAT TO GT_FIELDCAT.

  IF P_INFO = 'X'.
    CLEAR : GS_FIELDCAT.
    GS_FIELDCAT-COL_POS = 7.
    GS_FIELDCAT-FIELDNAME = 'ZQFLAG_NAME'.
    GS_FIELDCAT-SELTEXT_M = '퇴직상태'.
    APPEND GS_FIELDCAT TO GT_FIELDCAT.

    CLEAR : GS_FIELDCAT.
    GS_FIELDCAT-COL_POS = 8.
    GS_FIELDCAT-FIELDNAME = 'ZGENDER_NAME'.
    GS_FIELDCAT-SELTEXT_M = '성별'.
    APPEND GS_FIELDCAT TO GT_FIELDCAT.

    CLEAR : GS_FIELDCAT.
    GS_FIELDCAT-COL_POS = 9.
    GS_FIELDCAT-FIELDNAME = 'ZADDRESS'.
    GS_FIELDCAT-SELTEXT_M = '주소'.
    APPEND GS_FIELDCAT TO GT_FIELDCAT.

    CLEAR : GS_FIELDCAT.
    GS_FIELDCAT-COL_POS = 10.
    GS_FIELDCAT-FIELDNAME = 'ZBANKCODE'.
    GS_FIELDCAT-SELTEXT_M = '은행코드'.
    APPEND GS_FIELDCAT TO GT_FIELDCAT.

    CLEAR : GS_FIELDCAT.
    GS_FIELDCAT-COL_POS = 11.
    GS_FIELDCAT-FIELDNAME = 'ZBANK_NAME'.
    GS_FIELDCAT-SELTEXT_M = '은행명'.
    APPEND GS_FIELDCAT TO GT_FIELDCAT.

    CLEAR : GS_FIELDCAT.
    GS_FIELDCAT-COL_POS = 11.
    GS_FIELDCAT-FIELDNAME = 'ZACCOUNT'.
    GS_FIELDCAT-SELTEXT_M = '계좌번호'.
    APPEND GS_FIELDCAT TO GT_FIELDCAT.
  ELSEIF P_TEST = 'X'.
    CLEAR : GS_FIELDCAT.
    GS_FIELDCAT-COL_POS = 7.
    GS_FIELDCAT-FIELDNAME = 'ZSALARY'.
    GS_FIELDCAT-SELTEXT_M = '계약금액'.
    GS_FIELDCAT-OUTPUTLEN = '20'.
    GS_FIELDCAT-CURRENCY = 'KRW'.
    GS_FIELDCAT-DO_SUM = 'X'.
    APPEND GS_FIELDCAT TO GT_FIELDCAT.

    CLEAR : GS_FIELDCAT.
    GS_FIELDCAT-COL_POS = 8.
    GS_FIELDCAT-FIELDNAME = 'ZRANK'.
    GS_FIELDCAT-SELTEXT_M = '평가등급'.
    APPEND GS_FIELDCAT TO GT_FIELDCAT.

    CLEAR : GS_FIELDCAT.
    GS_FIELDCAT-COL_POS = 9.
    GS_FIELDCAT-FIELDNAME = 'ZMON'.
*    CONCATENATE P_MON '월지급액' INTO L_TEXT.
*    GS_FIELDCAT-SELTEXT_M = L_TEXT.
    GS_FIELDCAT-CURRENCY = 'KRW'.
    GS_FIELDCAT-DO_SUM = 'X'.
    APPEND GS_FIELDCAT TO GT_FIELDCAT.
  ENDIF.

ENDFORM.

FORM CALL_ALV .

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program = sy-repid    " 현재 프로그램 이름
      it_fieldcat        = GT_FIELDCAT " 필드 카탈로그
      IS_LAYOUT = GS_LAYOUT
      IT_SORT = GT_SORT
    TABLES
      t_outtab           = GT_PERNR  " 출력할 데이터
    EXCEPTIONS
      program_error      = 1
      OTHERS             = 2.

  IF sy-subrc <> 0.
    WRITE: / 'ALV 출력 중 오류가 발생했습니다.'.
  ENDIF.

ENDFORM.

FORM ALV_LAYOUT.

  GS_LAYOUT-NO_COLHEAD = 'X'.
  GS_LAYOUT-ZEBRA = 'X'.
  GS_LAYOUT-NO_VLINE = 'X'.
  GS_LAYOUT-NO_HLINE = 'X'.
  GS_LAYOUT-EDIT = 'X'.
  GS_LAYOUT-TOTALS_BEFORE_ITEMS = 'X'.

ENDFORM.

FORM ALV_SORT.

  GS_SORT-SPOS = 1.
  GS_SORT-FIELDNAME = 'ZCODE'.
  GS_SORT-UP = 'X'.
*  GS_SORT-SUBTOT = 'X'.
  APPEND GS_SORT TO GT_SORT.

ENDFORM.